APPNAME = 'akvo-flow'

require 'json'
require 'rake-pipeline-web-filters'

WebFilters = Rake::Pipeline::Web::Filters

class LoaderFilter < WebFilters::MinispadeFilter
  def generate_output(inputs, output)
    inputs.each do |input|
      code = input.read
      module_id = @module_id_generator.call(input)
      contents = "function(require) {\n#{code}\n}"
      ret = "\nloader.register('#{module_id}', #{contents});\n"
      output.write ret
    end
  end
end

output '../GAE/target/akvo-flow/vendorjs'
input 'app' do
  match "js/vendor/**/*.js" do
    concat do |input|
      input
    end
  end
end

output 'test_assets'
input 'app' do
  match 'tests/**/*.js' do
    filter LoaderFilter,
      :module_id_generator => proc { |input|
        input.path.sub(/^lib\//, "#{APPNAME}/").sub(/\.js$/, '')
      }
    concat 'app-tests.js'
  end
end

# vim: filetype=ruby
