version: v1.0
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: "Build and test"
    task:
      prologue:
        commands:
          - checkout
          - cache restore "m2-$(checksum GAE/pom.xml)"
          - cache restore "npm-$(checksum Dashboard/package.json)"
      epilogue:
        commands:
          - cache store "m2-$(checksum GAE/pom.xml)" "$HOME/.m2"
          - cache store "npm-$(checksum Dashboard/package.json)" "$HOME/.npm"
      jobs:
        - name: Build and test
          commands:
            - ./ci/bootstrap-build.sh /app/src/ci/build.sh
            - cache store "gae-target-$SEMAPHORE_GIT_SHA" "GAE/target"
promotions:
  - name: Deploy
    pipeline_file: deploy.yml
    auto_promote:
      when: "result = 'passed' and branch = 'master'"
